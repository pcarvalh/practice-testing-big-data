---
title: "Testing Effect -- Big Data Analyses"
output:
  html_document:
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
---
```{r Setup, include=FALSE}
rm(list=ls())
library(readr)
library(lmerTest)
library(plyr)
library(psych)
library(sjPlot)
library(car)
library(gridExtra)
library(MuMIn)
library(data.table)
library(sciplot)
library(lattice)
library(dplyr)
library(ggplot2)
```

# Import datasets and merge all datasets
```{r}
#import
SumData_ds863 <- read_csv("measures/SumData_ds863.csv")

SumData_ds2033 <- read_csv("measures/SumData_ds2033.csv")

SumData_ds490 <- read_csv("measures/SumData_ds490.csv")

#merge
dbs <-  rbind(SumData_ds863,SumData_ds2033,SumData_ds490)
dbs <- dbs[-which(is.na(dbs$ds_anon_user_id)),]
```

# Add variables not in dataset yet
```{r}
dbs$time_perPage <-  dbs$TimeReadTrimmed/dbs$NRead_trimmed
dbs$time_perDo <-  dbs$TimeAction/dbs$NAction
dbs$time_perPage <-  ifelse(is.na(dbs$time_perPage),0,dbs$time_perPage)
dbs$time_perDo <-   ifelse(is.na(dbs$time_perDo),0,dbs$time_perDo)

dbs$time_perPage <-  ifelse(is.infinite(dbs$time_perPage),0,dbs$time_perPage)
dbs$time_perDo <-   ifelse(is.infinite(dbs$time_perDo),0,dbs$time_perDo)

dbs$readTime_perWord <- dbs$TimeReadTrimmed/dbs$wordcount
dbs$readTime_perWord <- ifelse(is.na(dbs$readTime_perWord),0,dbs$readTime_perWord)

dbs$correctness_alltries <- ifelse(is.na(dbs$correctness_alltries),0,dbs$correctness_alltries)      
dbs$correctness_firsttry <- ifelse(is.na(dbs$correctness_firsttry),0,dbs$correctness_alltries)            
dbs$meanAttempts <- ifelse(is.na(dbs$meanAttempts),0,dbs$correctness_alltries)

dbs$repeated_activities <- dbs$NAction - dbs$NAction_unique
dbs$repeated_pages <- dbs$NRead_trimmed - dbs$NRead_trimmed_unique
dbs$alternation <- dbs$CountActionToPage + dbs$CountPageToAction

dbs$percentActivities <- ifelse(is.na(dbs$percentActivities),0,dbs$percentActivities)
dbs$percentPages <- ifelse(is.na(dbs$percentPages),0,dbs$percentActivities)

dbs$activity_group <- ifelse(dbs$NAction>0,"2_Activities","1_No Activities")
dbs$read_group <- ifelse(dbs$NRead_trimmed>0,"2_Read","1_No Read")

```

# Descriptives for the dataset
```{r}
describe(dbs)
describeBy(x = dbs,group = dbs$domain)
describeBy(x = dbs,group = dbs$dataset)
```

# Normalize things
```{r}
dbs <- ddply(.data = dbs,.variables = .(dataset),.fun = mutate,zNRead = scale(NRead),zNread_unique=scale(NRead_unique),zNRead_trimmed=scale(NRead_trimmed),zNRead_trimmed_unique=scale(NRead_trimmed_unique),zNAction=scale(NAction),zNAction_unique=scale(NAction_unique),logTimeRead = log(TimeRead),logTimeReadTrimmed=log(TimeReadTrimmed),logTimeAction=log(TimeAction),logTimeActionToPage=log(TimeActionToPage),logTimePageToAction=log(TimePageToAction),zCountActionToPage=scale(CountActionToPage),zCountPageToAction=scale(CountPageToAction),zwordcount=scale(wordcount),znpages=scale(npages),znactivities=scale(nactivities),znfigures=scale(nfigures),zreading_rate=scale(reading_rate),zpercentActivities=scale(percentActivities),zpercentPages=scale(percentPages),logretention_interval=log(retention_interval),zcorrectness_alltries=scale(correctness_alltries),zcorrectness_firsttry=scale(correctness_firsttry),zmeanAttempts=scale(meanAttempts),zpretestGrade=scale(pretestGrade),zquizGrade=scale(quizGrade),zexamGrade=scale(examGrade),logtime_perPage=log(time_perPage),logtime_perDo=log(time_perDo),logreadTime_perWord=log(readTime_perWord),zrepeated_activities=scale(repeated_activities),zrepeated_pages=scale(repeated_pages),zalternation=scale(alternation),.progress = "text")

is.na(dbs) <- do.call(cbind,lapply(dbs, is.infinite))
```

# Check variability for each domain/dataset
```{r}
var_db_psych <- ddply(.data = dbs[dbs$dataset=="ds863",],.variables = .(ds_anon_user_id),.fun = summarize,cv_do=sd(NAction,na.rm = T)/mean(NAction,na.rm = T),cv_read=sd(NRead_trimmed,na.rm = T)/mean(NRead_trimmed,na.rm = T),sd_do=sd(NAction,na.rm = T),sd_read=sd(NRead_trimmed,na.rm = T))
var_db_psych
mean(var_db_psych$sd_do,na.rm=T)
min(var_db_psych$sd_do,na.rm=T)
max(var_db_psych$sd_do,na.rm=T)
mean(var_db_psych$sd_read,na.rm=T)

var_module_db_psych <- ddply(.data = dbs[dbs$dataset=="ds863",],.variables = .(module),.fun = summarize,cv_do=sd(NAction)/mean(NAction),cv_read=sd(NRead_trimmed)/mean(NRead_trimmed),sd_do=sd(NAction),sd_read=sd(NRead_trimmed))
var_module_db_psych
mean(var_module_db_psych$sd_do,na.rm=T)
min(var_module_db_psych$sd_do)
max(var_module_db_psych$sd_do)
mean(var_module_db_psych$sd_read)

var_db_ccm <- ddply(.data = dbs[!dbs$dataset=="ds863",],.variables = .(ds_anon_user_id),.fun = summarize,cv_do=sd(NAction,na.rm = T)/mean(NAction,na.rm = T),cv_read=sd(NRead_trimmed,na.rm = T)/mean(NRead_trimmed,na.rm = T),sd_do=sd(NAction,na.rm = T),sd_read=sd(NRead_trimmed,na.rm = T))
var_db_ccm

var_module_db_ccm <- ddply(.data = dbs[!dbs$dataset=="ds863",],.variables = .(module),.fun = summarize,cv_do=sd(NAction)/mean(NAction),cv_read=sd(NRead_trimmed)/mean(NRead_trimmed),sd_do=sd(NAction),sd_read=sd(NRead_trimmed))
var_module_db_ccm

```

# Visualize measures of interest for Psych domain dataset
## What is the effect of completing more activities?
```{r}
dbs_psych <-  dbs[dbs$dataset=="ds863",]
dbs_psych <- mutate(dbs_psych,quantile_naction=ntile(dbs_psych$NAction,10))
dbs_psych <- as.data.table(dbs_psych)

dbs_psych_sum <- dbs_psych[,.(grade=mean(quizGrade),naction_avg=mean(NAction),n=.N),by=.(quantile_naction)]

activities_psych <- ggplot(data=dbs_psych_sum, aes(x=naction_avg, y=grade)) + geom_point(aes(size = n/100)) + theme_classic() + xlab("Number of Activities Completed") + ylab("Quiz Grade") + scale_linetype(name="Retention Interval Quintile") + scale_shape_discrete(name="Retention Interval Quintile") + theme(legend.justification=c(1,0), legend.position="none",plot.title = element_text(hjust = 0.5)) + ggtitle("Practice") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm") + scale_size_identity()
activities_psych
```

## What is the effect of viewing more pages?
```{r}
dbs_psych <-  dbs[dbs$dataset=="ds863",]
dbs_psych <- mutate(dbs_psych,quantile_nread=ntile(dbs_psych$NRead_trimmed,10))
dbs_psych <- as.data.table(dbs_psych)

dbs_psych_sum <- dbs_psych[,.(grade=mean(quizGrade),nread_avg=mean(NRead_trimmed),n=.N),by=.(quantile_nread)]

library(ggplot2)
read_psych <- ggplot(data=dbs_psych_sum, aes(x=nread_avg, y=grade)) + geom_point(aes(size = n/100)) + theme_classic() + xlab("Number of Pages Viewed") + ylab("Quiz Grade") + scale_linetype(name="Retention Interval Quintile") + scale_shape_discrete(name="Retention Interval Quintile") + theme(legend.justification=c(1,0), legend.position="none",plot.title = element_text(hjust = 0.5)) + ggtitle("Reading") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm") + scale_size_identity()
read_psych
```

## Is the effect modulated by repetition?
```{r}
dbs_psych <-  dbs[dbs$dataset=="ds863",]
dbs_psych <- mutate(dbs_psych,quantile_repetition = ntile(dbs_psych$repeated_activities,5),quantile_naction=ntile(dbs_psych$NAction,10),repetition=ifelse(dbs_psych$repeated_activities==0,"No Repetition","Repetition"))
dbs_psych <- as.data.table(dbs_psych)

dbs_psych_sum <- dbs_psych[,.(grade=mean(quizGrade),naction_avg=mean(NAction),n=.N),by=.(quantile_naction,repetition)]

dbs_psych_sum$repetition <- as.factor(dbs_psych_sum$repetition)

library(ggplot2)
repetition_psych <-ggplot(data=dbs_psych_sum, aes(x=naction_avg, y=grade, group=repetition)) + geom_point(aes(color=repetition,size=n/100)) + geom_point(aes(color=repetition)) + theme_classic() + xlab("Number of Activities Completed") + ylab("Quiz Grade") + scale_linetype(name="") + scale_color_discrete(name="") + theme(legend.justification=c(1,0), legend.position="top",plot.title = element_text(hjust = 0.5),legend.title = element_text("")) + ggtitle("Repetition") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm",aes(color=repetition)) + scale_size_identity()
repetition_psych
```

## All plots
```{r}
library(ggpubr)
ggarrange(plotlist = list(activities_psych,read_psych,repetition_psych),nrow=2,ncol=2)
```

# Visualize measures of interest for Computing domain dataset
## What is the effect of completing more activities?
```{r}
dbs_computing <-  dbs[!dbs$dataset=="ds863",]
dbs_computing <- mutate(dbs_computing,quantile_naction=ntile(dbs_computing$NAction,10))
dbs_computing <- as.data.table(dbs_computing)

dbs_computing_sum <- dbs_computing[,.(grade=mean(quizGrade),naction_avg=mean(NAction),n=.N),by=.(quantile_naction)]

activities_computing <- ggplot(data=dbs_computing_sum, aes(x=naction_avg, y=grade)) + geom_point(aes(size = n/25)) + theme_classic() + xlab("Number of Activities Completed") + ylab("Quiz Grade") + scale_linetype(name="Retention Interval Quintile") + scale_shape_discrete(name="Retention Interval Quintile") + theme(legend.justification=c(1,0), legend.position="none",plot.title = element_text(hjust = 0.5)) + ggtitle("Practice") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm") + scale_size_identity()
activities_psych
```

## What is the effect of viewing more pages?
```{r}
dbs_computing <-  dbs[!dbs$dataset=="ds863",]
dbs_computing <- mutate(dbs_computing,quantile_nread=ntile(dbs_computing$NRead_trimmed,10))
dbs_computing <- as.data.table(dbs_computing)

dbs_computing_sum <- dbs_computing[,.(grade=mean(quizGrade),nread_avg=mean(NRead_trimmed),n=.N),by=.(quantile_nread)]

library(ggplot2)
read_computing <- ggplot(data=dbs_computing_sum, aes(x=nread_avg, y=grade)) + geom_point(aes(size = n/25)) + theme_classic() + xlab("Number of Pages Viewed") + ylab("Quiz Grade") + scale_linetype(name="Retention Interval Quintile") + scale_shape_discrete(name="Retention Interval Quintile") + theme(legend.justification=c(1,0), legend.position="none",plot.title = element_text(hjust = 0.5)) + ggtitle("Reading") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm") + scale_size_identity()
read_computing
```

## Is the effect modulated by repetition?
```{r}
dbs_computing <-  dbs[!dbs$dataset=="ds863",]
dbs_computing <- mutate(dbs_computing,quantile_repetition = ntile(dbs_computing$repeated_activities,5),quantile_naction=ntile(dbs_computing$NAction,10),repetition=ifelse(dbs_computing$repeated_activities==0,"No Repetition","Repetition"))
dbs_computing <- as.data.table(dbs_computing)

dbs_computing_sum <- dbs_computing[,.(grade=mean(quizGrade),naction_avg=mean(NAction),n=.N),by=.(quantile_naction,repetition)]

dbs_computing_sum$repetition <- as.factor(dbs_computing_sum$repetition)

repetition_computing <-ggplot(data=dbs_computing_sum, aes(x=naction_avg, y=grade, group=repetition)) + geom_point(aes(color=repetition,size=n/25)) + geom_point(aes(color=repetition)) + theme_classic() + xlab("Number of Activities Completed") + ylab("Quiz Grade") + scale_linetype(name="") + scale_color_discrete(name="") + theme(legend.justification=c(1,0), legend.position="top",plot.title = element_text(hjust = 0.5)) + ggtitle("Repetition") + coord_cartesian(ylim=c(0.70,0.95)) + geom_smooth(method = "lm",aes(color=repetition)) + scale_size_identity()
repetition_computing
```

## All plots
```{r}
library(ggpubr)
ggarrange(plotlist = list(activities_computing,read_computing,repetition_computing),nrow=2,ncol=2)
```

# Compare effect of reading on benefit of activities across domains
```{r}
ggarrange(plotlist = list(interaction_psych,interaction_computing),nrow=1,ncol=2)
```

# Statistical models
## Do vs. no do and read vs. no read
### Psych
```{r}
summary(absolute_read <- lmer(zquizGrade ~ zpretestGrade+activity_group+read_group+(1|ds_anon_user_id),data = dbs[dbs$dataset=="ds863",]))
```

### Computing
```{r}
summary(absolute_read <- lmer(zquizGrade ~ zpretestGrade+activity_group+read_group+(1|ds_anon_user_id),data = dbs[!dbs$dataset=="ds863",]))
```

## Dosage of doing/reading
### Psych
```{r}
summary(dosage <- lmer(zquizGrade ~ zpretestGrade+zNRead_trimmed+zNAction+(1|ds_anon_user_id),data = dbs[dbs$dataset=="ds863",]))
```

### Computing
```{r}
summary(dosage <- lmer(zquizGrade ~ zpretestGrade+zNRead_trimmed+zNAction+(1|ds_anon_user_id),data = dbs[!dbs$dataset=="ds863",]))
```

## Dosage effect modulated by repetition?
### Psych
```{r}
summary(repetition <- lmer(zquizGrade ~ zpretestGrade+zNAction_unique+zrepeated_activities+(1|ds_anon_user_id),data = dbs[dbs$dataset=="ds863",]))
```

### Computing
```{r}
summary(repetition <- lmer(zquizGrade ~ zpretestGrade+zNAction_unique+zrepeated_activities+(1|ds_anon_user_id),data = dbs[!dbs$dataset=="ds863",]))
```
